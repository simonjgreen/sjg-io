---
import { getCollection } from 'astro:content';
import Card from './Card.astro';

interface Props {
  slug: string;
  children?: any;
}

const { slug: slugProp, children } = Astro.props;

// Remove /writing/ prefix if present
const cleanSlug = slugProp.replace(/^\/writing\//, '').replace(/\/$/, '');

let post;
try {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  post = posts.find(p => p.slug === cleanSlug);
} catch (e) {
  post = null;
}

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};
---

{post ? (
  <Card href={`/writing/${post.slug}`} class="mt-8">
    <div class="p-6">
      {post.data.image && (
        <img 
          src={post.data.image} 
          alt={post.data.title}
          class="w-full h-32 object-cover rounded-lg mb-4"
        />
      )}
      <h3 class="text-xl font-black text-gray-900 dark:text-white">
        {post.data.previewTitle || post.data.title}
      </h3>
      <p class="mt-3 text-base text-gray-600 dark:text-gray-300">
        {post.data.previewDescription || post.data.description}
      </p>
      <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">
        {formatDate(post.data.date)}
      </p>
    </div>
  </Card>
) : children ? (
  <a href={slugProp.startsWith('/') ? slugProp : `/writing/${cleanSlug}`}>
    {children}
  </a>
) : null}
