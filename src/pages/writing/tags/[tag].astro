---
import Base from '../../../layouts/Base.astro';
import Card from '../../../components/Card.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  
  // Get all unique tags
  const allTags = new Set<string>();
  posts.forEach(post => {
    post.data.tags?.forEach(tag => allTags.add(tag));
  });
  
  return Array.from(allTags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.params;
if (!tag) {
  return Astro.redirect('/writing');
}

const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const postsWithTag = allPosts
  .filter(post => post.data.tags?.includes(tag))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};
---

<Base 
  title={`Posts tagged "${tag}"`}
  description={`All posts tagged with "${tag}"`}
>
  <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-12">
    <div class="max-w-3xl">
      <nav class="mb-6">
        <a 
          href="/writing" 
          class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
        >
          ‚Üê Back to all writing
        </a>
      </nav>
      <h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl">
        Posts tagged "{tag}"
      </h1>
      <p class="mt-6 text-xl leading-8 text-gray-600 dark:text-gray-300">
        {postsWithTag.length === 1 
          ? '1 post' 
          : `${postsWithTag.length} posts`}
      </p>
    </div>

    <div class="mt-12 space-y-8">
      {postsWithTag.map((post) => (
        <Card class="cursor-pointer post-card" data-href={`/writing/${post.slug}`}>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white hover:text-neon-blue dark:hover:text-neon-blue transition-colors">
            {post.data.title}
          </h2>
          <p class="mt-2 text-gray-600 dark:text-gray-300">
            {post.data.description}
          </p>
          <div class="mt-4 flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
            <time datetime={post.data.date.toISOString()}>
              {formatDate(post.data.date)}
            </time>
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map((postTag) => (
                  <a
                    href={`/writing/tags/${postTag}`}
                    class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium transition-colors ${
                      postTag === tag
                        ? 'bg-gray-200 text-gray-900 dark:bg-gray-600 dark:text-gray-100'
                        : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600'
                    }`}
                    onclick="event.stopPropagation()"
                  >
                    {postTag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </Card>
      ))}
    </div>

    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.post-card').forEach((card) => {
          card.addEventListener('click', (e) => {
            // Don't navigate if clicking on a link
            if (e.target.closest('a')) {
              return;
            }
            const href = card.getAttribute('data-href');
            if (href) {
              window.location.href = href;
            }
          });
        });
      });
    </script>

    {postsWithTag.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">
          No posts found with this tag.
        </p>
      </div>
    )}
  </div>
</Base>

